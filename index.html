<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ tạo câu hỏi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* General body styling, adopted from the question creator tab */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Styles for the question creator tool */
        #analysisResultSection {
            transition: opacity 0.5s ease-in-out;
        }
        .analysis-card, .question-card-container {
            transition: all 0.3s ease-in-out;
        }
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .image-preview {
            max-width: 80px;
            max-height: 80px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
        .spinner {
            animation: spin 1s linear infinite;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .difficulty-easy { background-color: #dcfce7; color: #166534; }
        .difficulty-medium { background-color: #dbeafe; color: #1e40af; }
        .difficulty-hard { background-color: #ffedd5; color: #9a3412; }
        .cognitive-recognition { background-color: #e0e7ff; color: #3730a3; }
        .cognitive-comprehension { background-color: #cffafe; color: #0891b2; }
        .cognitive-application { background-color: #fef9c3; color: #854d0e; }
        .cognitive-high-order-application { background-color: #fee2e2; color: #991b1b; }
        .group-lead {
            background-color: #e5e7eb;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-style: italic;
            color: #4b5563;
        }
        .ai-format-btn {
            padding: 4px;
            border-radius: 50%;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ai-format-btn:hover {
            background-color: #e0e7ff;
        }
        .ai-format-btn svg {
            width: 16px;
            height: 16px;
            color: #4f46e5;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Question Creator Content -->
        <div id="tab-question-creator">
             <div class="container mx-auto p-0 sm:p-2 md:p-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Input and Analysis Column -->
                    <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                        <div class="space-y-6">
                            <h2 class="text-2xl font-semibold mb-2 border-b pb-3">Bước 1: Nhập liệu</h2>
                             <div>
                                <div class="flex justify-between items-center mb-1">
                                     <label for="qc-apiKey" class="block text-sm font-medium text-gray-700">
                                       API Key của bạn
                                    </label>
                                    <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer" class="text-xs text-indigo-600 hover:underline font-medium">
                                        (Lấy API Key ở đây)
                                    </a>
                                </div>
                                <input type="password" id="qc-apiKey" name="apiKey" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nhập API Key của bạn tại đây">
                            </div>
                            <div>
                                <label for="qc-subject" class="block text-sm font-medium text-gray-700 mb-1">
                                   Chọn môn học cho loạt câu hỏi này
                                </label>
                                <select id="qc-subject" name="subject" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="chemistry">Hóa học</option>
                                    <option value="physics">Vật lý</option>
                                    <option value="biology">Sinh học</option>
                                    <option value="math">Toán</option>
                                    <option value="history">Lịch sử</option>
                                    <option value="geography">Địa lý</option>
                                    <option value="literature">Ngữ văn</option>
                                    <option value="english">Tiếng Anh</option>
                                    <option value="other">Khác</option>
                                </select>
                             </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label for="rawQuestionText" class="block text-sm font-medium text-gray-700">Dán văn bản hoặc hình ảnh câu hỏi vào đây:</label>
                                    <button type="button" class="ai-format-btn" onclick="formatTextWithAI(this)" title="Định dạng văn bản bằng AI">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.38 10.27a.75.75 0 01.67-.52h6.9a.75.75 0 01.67.52l.34 1.7a.75.75 0 01-.52.84l-1.7.34a.75.75 0 01-.84-.52l-.34-1.7a.75.75 0 00-.67-.52h-1.7a.75.75 0 00-.67.52l-.34 1.7a.75.75 0 01-.84.52l-1.7-.34a.75.75 0 01-.52-.84l.34-1.7z"></path><path fill-rule="evenodd" d="M3 9.34a.75.75 0 01.75-.75h12.5a.75.75 0 010 1.5H3.75A.75.75 0 013 9.34zM10 3.16a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3.16zM8.5 5.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM5.5 8.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 015.5 8.5zm9 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM10 16.84a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5a.75.75 0 01-.75.75zM8.5 14.5a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75zm6.5 0a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75z" clip-rule="evenodd"></path></svg>
                                    </button>
                                </div>
                                <textarea id="rawQuestionText" rows="10" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Dán văn bản hoặc hình ảnh câu hỏi vào đây..."></textarea>
                            </div>
                            <button id="analyzeBtn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <span id="analyzeBtnText">Phân tích văn bản bằng AI</span>
                                <div id="analyzeBtnSpinner" class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                            </button>
                        </div>
                        
                        <div id="analysisResultContainer" class="space-y-6 hidden">
                             <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Bước 2: Xác nhận và Thêm</h2>
                             <div id="analysisResultSection" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                             </div>
                             <button id="addAllToListBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Thêm tất cả vào danh sách
                            </button>
                        </div>
                    </div>
        
                    <div class="space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4 border-b pb-4">
                                <h2 class="text-2xl font-semibold">Danh sách câu hỏi</h2>
                                <div class="flex gap-2">
                                    <button id="addQuestionBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md text-sm">Thêm câu hỏi mới</button>
                                    <button id="groupBtn" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md text-sm">Nhóm câu hỏi đã chọn</button>
                                </div>
                            </div>
                            <div id="questionsList" class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                                <p id="emptyListMessage" class="text-gray-500 text-center py-4">Chưa có câu hỏi nào.</p>
                            </div>
                        </div>
        
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-semibold text-white">Kết quả JSON</h2>
                                <div class="flex space-x-2">
                                    <button id="importJsonBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md text-sm">Nhập file</button>
                                    <button id="copyJsonBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md text-sm">Sao chép</button>
                                    <button id="downloadJsonBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md text-sm">Tải xuống</button>
                                    <input type="file" id="importFileInput" class="hidden" accept=".json,application/json">
                                </div>
                            </div>
                            <pre id="jsonOutput" class="bg-gray-900 text-green-300 p-4 rounded-md text-sm overflow-x-auto h-64"><code>// JSON sẽ tự động cập nhật ở đây...</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Edit Modal -->
            <div id="editModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto p-6 space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800">Chỉnh sửa câu hỏi</h2>
                    <input type="hidden" id="editQuestionId">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="editQuestionIdNumber" class="block text-sm font-medium text-gray-700">ID Câu hỏi</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <span id="editQuestionIdPrefix" class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">P</span>
                                <input type="number" id="editQuestionIdNumber" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300">
                            </div>
                        </div>
                        <div>
                            <label for="editSubject" class="block text-sm font-medium text-gray-700">Môn học</label>
                            <select id="editSubject" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="editCognitiveLevel" class="block text-sm font-medium text-gray-700">Mức độ nhận thức</label>
                            <select id="editCognitiveLevel" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="recognition">Nhận biết</option>
                                <option value="comprehension">Thông hiểu</option>
                                <option value="application">Vận dụng</option>
                                <option value="high-order-application">Vận dụng cao</option>
                            </select>
                        </div>
                        <div>
                            <label for="editDifficulty" class="block text-sm font-medium text-gray-700">Độ khó</label>
                            <select id="editDifficulty" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="easy">Dễ</option>
                                <option value="medium">Trung bình</option>
                                <option value="hard">Khó</option>
                            </select>
                        </div>
                    </div>
                     <div>
                        <label for="editQuestionType" class="block text-sm font-medium text-gray-700">Loại câu hỏi</label>
                        <select id="editQuestionType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="mc">Trắc nghiệm (MC)</option>
                            <option value="tf">Đúng/Sai (TF)</option>
                            <option value="fib">Điền khuyết (FIB)</option>
                             <option value="group">Nhóm Đúng/Sai (Group)</option>
                        </select>
                    </div>
                    <div id="edit-non-group-fields">
                        <div>
                             <div class="flex justify-between items-center">
                                <label for="editQuestionText" class="block text-sm font-medium text-gray-700">Nội dung câu hỏi</label>
                                 <button type="button" class="ai-format-btn" onclick="formatTextWithAI(this)" title="Định dạng văn bản bằng AI">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.38 10.27a.75.75 0 01.67-.52h6.9a.75.75 0 01.67.52l.34 1.7a.75.75 0 01-.52.84l-1.7.34a.75.75 0 01-.84-.52l-.34-1.7a.75.75 0 00-.67-.52h-1.7a.75.75 0 00-.67.52l-.34 1.7a.75.75 0 01-.84.52l-1.7-.34a.75.75 0 01-.52-.84l.34-1.7z"></path><path fill-rule="evenodd" d="M3 9.34a.75.75 0 01.75-.75h12.5a.75.75 0 010 1.5H3.75A.75.75 0 013 9.34zM10 3.16a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3.16zM8.5 5.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM5.5 8.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 015.5 8.5zm9 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM10 16.84a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5a.75.75 0 01-.75.75zM8.5 14.5a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75zm6.5 0a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75z" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                            <textarea id="editQuestionText" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm font-medium text-gray-700">Đáp án</label>
                            <div id="editAnswerSection" class="mt-2 space-y-2"></div>
                        </div>
                    </div>
                    <div id="edit-group-fields" class="hidden">
                        <div>
                             <div class="flex justify-between items-center">
                                <label for="editGroupPrompt" class="block text-sm font-medium text-gray-700">Phần dẫn chung</label>
                                 <button type="button" class="ai-format-btn" onclick="formatTextWithAI(this)" title="Định dạng văn bản bằng AI">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.38 10.27a.75.75 0 01.67-.52h6.9a.75.75 0 01.67.52l.34 1.7a.75.75 0 01-.52.84l-1.7.34a.75.75 0 01-.84-.52l-.34-1.7a.75.75 0 00-.67-.52h-1.7a.75.75 0 00-.67.52l-.34 1.7a.75.75 0 01-.84.52l-1.7-.34a.75.75 0 01-.52-.84l.34-1.7z"></path><path fill-rule="evenodd" d="M3 9.34a.75.75 0 01.75-.75h12.5a.75.75 0 010 1.5H3.75A.75.75 0 013 9.34zM10 3.16a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3.16zM8.5 5.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM5.5 8.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 015.5 8.5zm9 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM10 16.84a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5a.75.75 0 01-.75.75zM8.5 14.5a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75zm6.5 0a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75z" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                            <textarea id="editGroupPrompt" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700">Các câu hỏi con</label>
                            <div id="editSubQuestionsContainer" class="mt-2 space-y-2"></div>
                            <button type="button" id="addSubQuestionBtn" class="mt-2 text-sm text-indigo-600 hover:underline">Thêm câu hỏi con</button>
                        </div>
                    </div>
                     <div class="mt-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="editRequiresCalculation" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Yêu cầu tính toán</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hình ảnh</label>
                        <div class="mt-2 flex items-center space-x-4 p-2 border-2 border-dashed border-gray-300 rounded-md">
                            <div id="editImageSpinner" class="spinner hidden"></div>
                            <img id="editImagePreview" src="" class="image-preview hidden">
                            <span id="editNoImageText" class="text-gray-500">Chưa có ảnh.</span>
                            <div class="flex-grow"></div>
                            <input type="file" id="editImageInput" class="hidden" accept="image/*">
                            <button type="button" id="pasteEditImageBtn" class="text-sm bg-blue-100 text-blue-800 font-semibold py-1 px-3 rounded-full hover:bg-blue-200">Dán ảnh</button>
                            <button type="button" onclick="document.getElementById('editImageInput').click()" class="text-sm bg-gray-100 text-gray-700 font-semibold py-1 px-3 rounded-full hover:bg-gray-200">Chọn file</button>
                            <button type="button" id="removeEditImageBtn" class="text-sm text-red-600 font-semibold hover:underline hidden">Xóa ảnh</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4 border-t">
                        <button id="ungroupBtn" class="hidden bg-red-100 text-red-800 font-bold py-2 px-6 rounded-md text-sm">Bỏ nhóm</button>
                        <div class="flex justify-end space-x-3 flex-grow">
                            <button id="cancelEditBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-md">Hủy</button>
                            <button id="saveEditBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Lưu thay đổi</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grouping Modal -->
            <div id="groupModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800">Nhóm câu hỏi</h2>
                    <p class="text-sm text-gray-600">Nhập phần dẫn chung cho các câu hỏi đã chọn. Các câu hỏi này sẽ được chuyển thành dạng Đúng/Sai (TF).</p>
                    <div>
                         <div class="flex justify-between items-center">
                            <label for="groupPromptInput" class="block text-sm font-medium text-gray-700">Phần dẫn chung</label>
                             <button type="button" class="ai-format-btn" onclick="formatTextWithAI(this)" title="Định dạng văn bản bằng AI">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.38 10.27a.75.75 0 01.67-.52h6.9a.75.75 0 01.67.52l.34 1.7a.75.75 0 01-.52.84l-1.7.34a.75.75 0 01-.84-.52l-.34-1.7a.75.75 0 00-.67-.52h-1.7a.75.75 0 00-.67.52l-.34 1.7a.75.75 0 01-.84.52l-1.7-.34a.75.75 0 01-.52-.84l.34-1.7z"></path><path fill-rule="evenodd" d="M3 9.34a.75.75 0 01.75-.75h12.5a.75.75 0 010 1.5H3.75A.75.75 0 013 9.34zM10 3.16a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3.16zM8.5 5.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM5.5 8.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 015.5 8.5zm9 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM10 16.84a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5a.75.75 0 01-.75.75zM8.5 14.5a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75zm6.5 0a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <textarea id="groupPromptInput" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button id="cancelGroupBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-md">Hủy</button>
                        <button id="confirmGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md">Xác nhận</button>
                    </div>
                </div>
            </div>
        
            <!-- Message Box -->
            <div id="messageBox" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white" style="display: none;"></div>
        </div>
    </div>

    <script>
        // --- QUESTION CREATOR LOGIC (IIFE) ---
        (function() {
            const qcContainer = document.getElementById('tab-question-creator');
            if (!qcContainer) return;

            const apiKeyInput = qcContainer.querySelector('#qc-apiKey');
            const analyzeBtn = qcContainer.querySelector('#analyzeBtn');
            const analyzeBtnText = qcContainer.querySelector('#analyzeBtnText');
            const analyzeBtnSpinner = qcContainer.querySelector('#analyzeBtnSpinner');
            const rawQuestionText = qcContainer.querySelector('#rawQuestionText');
            const analysisResultContainer = qcContainer.querySelector('#analysisResultContainer');
            const analysisResultSection = qcContainer.querySelector('#analysisResultSection');
            const addAllToListBtn = qcContainer.querySelector('#addAllToListBtn');
            const subjectSelect = qcContainer.querySelector('#qc-subject');
            const questionsList = qcContainer.querySelector('#questionsList');
            const groupBtn = qcContainer.querySelector('#groupBtn');
            const addQuestionBtn = qcContainer.querySelector('#addQuestionBtn');
            const jsonOutput = qcContainer.querySelector('#jsonOutput code');
            const copyJsonBtn = qcContainer.querySelector('#copyJsonBtn');
            const downloadJsonBtn = qcContainer.querySelector('#downloadJsonBtn');
            const messageBox = qcContainer.querySelector('#messageBox');
            const importJsonBtn = qcContainer.querySelector('#importJsonBtn');
            const importFileInput = qcContainer.querySelector('#importFileInput');
            
            // Edit Modal Elements
            const editModal = qcContainer.querySelector('#editModal');
            const editQuestionIdInput = qcContainer.querySelector('#editQuestionId');
            const editQuestionIdPrefix = qcContainer.querySelector('#editQuestionIdPrefix');
            const editQuestionIdNumber = qcContainer.querySelector('#editQuestionIdNumber');
            const editSubjectSelect = qcContainer.querySelector('#editSubject');
            const editQuestionTypeSelect = qcContainer.querySelector('#editQuestionType');
            const editCognitiveLevelSelect = qcContainer.querySelector('#editCognitiveLevel');
            const editDifficultySelect = qcContainer.querySelector('#editDifficulty');
            const editRequiresCalculationCheckbox = qcContainer.querySelector('#editRequiresCalculation');
            const editGroupFields = qcContainer.querySelector('#edit-group-fields');
            const editNonGroupFields = qcContainer.querySelector('#edit-non-group-fields');
            const editGroupPromptTextarea = qcContainer.querySelector('#editGroupPrompt');
            const editSubQuestionsContainer = qcContainer.querySelector('#editSubQuestionsContainer');
            const addSubQuestionBtn = qcContainer.querySelector('#addSubQuestionBtn');
            const editQuestionText = qcContainer.querySelector('#editQuestionText');
            const editAnswerSection = qcContainer.querySelector('#editAnswerSection');
            const saveEditBtn = qcContainer.querySelector('#saveEditBtn');
            const cancelEditBtn = qcContainer.querySelector('#cancelEditBtn');
            const ungroupBtn = qcContainer.querySelector('#ungroupBtn');
            const pasteEditImageBtn = qcContainer.querySelector('#pasteEditImageBtn');
            const editImagePreview = qcContainer.querySelector('#editImagePreview');
            const editImageInput = qcContainer.querySelector('#editImageInput');
            const removeEditImageBtn = qcContainer.querySelector('#removeEditImageBtn');
            const editNoImageText = qcContainer.querySelector('#editNoImageText');
            const editImageSpinner = qcContainer.querySelector('#editImageSpinner');

            // Group Modal Elements
            const groupModal = qcContainer.querySelector('#groupModal');
            const groupPromptInput = qcContainer.querySelector('#groupPromptInput');
            const confirmGroupBtn = qcContainer.querySelector('#confirmGroupBtn');
            const cancelGroupBtn = qcContainer.querySelector('#cancelGroupBtn');


            let questions = [];
            let parsedQuestions = [];

            function showMessage(text, isError = false) {
                if(!messageBox) return;
                messageBox.textContent = text;
                messageBox.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                messageBox.style.display = 'block';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000);
            }

            function getNextIdForSubject(subject, count) {
                const subjectPrefixes = { 'chemistry': 'C', 'physics': 'P', 'biology': 'B', 'math': 'M', 'history': 'H', 'geography': 'G', 'literature': 'L', 'english': 'E', 'other': 'O' };
                const prefix = subjectPrefixes[subject] || 'O';
                const existingIdsForSubject = questions
                    .filter(q => q.id.startsWith(prefix))
                    .map(q => parseInt(q.id.replace(prefix, ''), 10))
                    .filter(num => !isNaN(num));
                
                const maxId = existingIdsForSubject.length > 0 ? Math.max(...existingIdsForSubject) : 0;
                return `${prefix}${(maxId + count).toString().padStart(2, '0')}`;
            }

            async function callGeminiAPI(payload, isFormatting = false) {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showMessage('Vui lòng nhập API Key để sử dụng tính năng này.', true);
                    return null;
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Lỗi API: ${response.status}`);
                }
                const result = await response.json();
                if (!result.candidates || result.candidates.length === 0) {
                     throw new Error("API không trả về kết quả hợp lệ.");
                }
                const textContent = result.candidates[0].content.parts[0].text;
                
                if (isFormatting) {
                    return textContent;
                }

                parsedQuestions = JSON.parse(textContent);
                if (!parsedQuestions || parsedQuestions.length === 0) {
                        throw new Error("AI không nhận diện được câu hỏi nào.");
                }
                displayAnalysisResults(parsedQuestions);
            }

            function cleanAiHtmlResponse(text) {
                if (!text) return "";
                // This regex will match ``` followed by an optional language identifier and a newline,
                // and the closing ``` at the end of the string. It handles variations in whitespace.
                return text.replace(/^```[a-zA-Z]*\s*\n?/, '').replace(/\n?```\s*$/, '').trim();
            }

            window.formatTextWithAI = async function(button) {
                const textarea = button.parentElement.nextElementSibling;
                const text = textarea.value.trim();
                if (!text) return;

                const originalButtonContent = button.innerHTML;
                button.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>';
                button.disabled = true;

                try {
                    const prompt = `Format the following Vietnamese text for scientific display in HTML. Convert common notations like H_2O to H<sub>2</sub>O, x^2 to x<sup>2</sup>. Do not change the meaning or add extra words. Just format the existing text:\n\n---\n${text}\n---`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    let formattedText = await callGeminiAPI(payload, true);
                    if (formattedText) {
                        textarea.value = cleanAiHtmlResponse(formattedText);
                    }
                } catch (error) {
                    console.error("AI Formatting Error:", error);
                    showMessage(`Lỗi định dạng AI: ${error.message}`, true);
                } finally {
                    button.innerHTML = originalButtonContent;
                    button.disabled = false;
                }
            }

            async function analyzeTextWithAI() {
                const apiKey = apiKeyInput.value.trim();
                const text = rawQuestionText.value.trim();
                if (!apiKey) { showMessage('Vui lòng nhập API Key của bạn.', true); return; }
                if (!text) { showMessage('Vui lòng nhập nội dung câu hỏi.', true); return; }
                setLoadingState(true, 'Đang phân tích văn bản...');
                const prompt = `Analyze the following text which contains one or more questions. For each question, identify its type, question text, options, and answer. Also, classify it based on three criteria:
1.  **cognitiveLevel**: The cognitive skill required. Use one of these four values: "recognition", "comprehension", "application", "high-order-application".
2.  **difficulty**: The difficulty relative to its cognitive level. Use one of these three values: "easy", "medium", or "hard".
3.  **requiresCalculation**: A boolean value. Set to true if the question involves numbers and requires mathematical steps to solve, otherwise set to false.
The possible question types are: "mc" (Multiple choice), "tf" (True/False), "mtf" (Multiple True/False, where 'options' contains statements and 'answer' is an array of booleans), "fib" (Fill-in-the-blank). 
RULES: 1. Remove any leading question numbers. 2. For "fib", extract the answer from keys like "(ĐS: ...)" and remove the key from the question. 3. For "tf", if a statement ends with "Đ" or "S", set the answer to "true" or "false" and remove the letter. 4. For "mtf", treat the main question as the 'question' field, and each sub-item as an option and determine its boolean answer. 5. Format superscripts (e.g., x^2 to x<sup>2</sup>) and subscripts (e.g., H_2O to H<sub>2</sub>O) with HTML tags. Here is the text: --- ${text} ---`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { type: { type: "STRING", enum: ["mc", "tf", "mtf", "fib"] }, question: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, answer: { oneOf: [{ type: "STRING" }, { type: "ARRAY", items: { type: "BOOLEAN" } }] }, difficulty: { type: "STRING", enum: ["easy", "medium", "hard"] }, cognitiveLevel: { type: "STRING", enum: ["recognition", "comprehension", "application", "high-order-application"] }, requiresCalculation: { type: "BOOLEAN" } }, required: ["type", "question", "difficulty", "cognitiveLevel", "requiresCalculation"] } };
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                try {
                    await callGeminiAPI(payload);
                } catch (error) {
                    console.error("AI Text Analysis Error:", error);
                    showMessage(`Lỗi phân tích AI: ${error.message}`, true);
                } finally {
                    setLoadingState(false);
                }
            }

            async function analyzeImageWithAI(base64ImageData) {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) { showMessage('Vui lòng nhập API Key trước khi dán ảnh.', true); return; }
                setLoadingState(true, 'Đang nhận dạng ảnh...');
                const prompt = `Look at the image, extract all text, and then analyze it. For each question, identify its type, question text, options, and answer. Also, classify it based on three criteria:
1.  **cognitiveLevel**: The cognitive skill required. Use one of these four values: "recognition", "comprehension", "application", "high-order-application".
2.  **difficulty**: The difficulty relative to its cognitive level. Use one of these three values: "easy", "medium", or "hard".
3.  **requiresCalculation**: A boolean value. Set to true if the question involves numbers and requires mathematical steps to solve, otherwise set to false.
The possible question types are: "mc" (Multiple choice), "tf" (True/False), "mtf" (Multiple True/False, where 'options' contains statements and 'answer' is an array of booleans), "fib" (Fill-in-the-blank). 
RULES: 1. Remove any leading question numbers. 2. For "mc", detect the correct answer if it's highlighted and set the 'answer' to its zero-based index as a string. 3. For "fib", extract the answer from keys like "(ĐS: ...)" and remove the key from the question. 4. For "tf", if a statement ends with "Đ" or "S", set the answer to "true" or "false" and remove the letter. 5. For "mtf", treat the main question as the 'question' field, and each sub-item as an option and determine its boolean answer. 6. Format superscripts (e.g., x^2 to x<sup>2</sup>) and subscripts (e.g., H_2O to H<sub>2</sub>O) with HTML tags.`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { type: { type: "STRING", enum: ["mc", "tf", "mtf", "fib"] }, question: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, answer: { oneOf: [{ type: "STRING" }, { type: "ARRAY", items: { type: "BOOLEAN" } }] }, difficulty: { type: "STRING", enum: ["easy", "medium", "hard"] }, cognitiveLevel: { type: "STRING", enum: ["recognition", "comprehension", "application", "high-order-application"] }, requiresCalculation: { type: "BOOLEAN" } }, required: ["type", "question", "difficulty", "cognitiveLevel", "requiresCalculation"] } };
                const payload = { contents: [ { parts: [ { text: prompt }, { inlineData: { mimeType: "image/png", data: base64ImageData } } ] } ], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                try {
                    await callGeminiAPI(payload);
                } catch (error) {
                    console.error("AI Image Analysis Error:", error);
                    showMessage(`Lỗi phân tích ảnh AI: ${error.message}`, true);
                } finally {
                    setLoadingState(false);
                }
            }
            
            function handleImagePaste(event, callback) {
                const items = (event.clipboardData || window.clipboardData).items;
                let imageFile = null;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        imageFile = item.getAsFile();
                        break;
                    }
                }
                if (imageFile) {
                    event.preventDefault();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Data = e.target.result;
                        callback(base64Data);
                    };
                    reader.readAsDataURL(imageFile);
                }
            }

            rawQuestionText.addEventListener('paste', (event) => {
                handleImagePaste(event, (base64Data) => {
                    analyzeImageWithAI(base64Data.split(',')[1]);
                });
            });

            function setLoadingState(isLoading, message = 'Phân tích văn bản bằng AI') {
                if (isLoading) {
                    analyzeBtn.disabled = true;
                    analyzeBtnText.textContent = message;
                    analyzeBtnSpinner.classList.remove('hidden');
                } else {
                    analyzeBtn.disabled = false;
                    analyzeBtnText.textContent = 'Phân tích văn bản bằng AI';
                    analyzeBtnSpinner.classList.add('hidden');
                }
            }

            analyzeBtn.addEventListener('click', analyzeTextWithAI);

            function displayAnalysisResults(results) {
                analysisResultSection.innerHTML = '';
                results.forEach((parsedData, index) => {
                    const card = createAnalysisCard(parsedData, index);
                    analysisResultSection.appendChild(card);
                });
                analysisResultContainer.classList.remove('hidden');
                showMessage(`AI đã phân tích xong ${results.length} câu hỏi. Vui lòng xác nhận đáp án và độ khó.`, false);
            }
            
            function createAnalysisCard(parsedData, index) {
                const card = document.createElement('div');
                card.className = 'analysis-card bg-gray-50 p-4 rounded-lg border border-gray-200';
                card.dataset.index = index;
                let answerHtml = '';
                switch (parsedData.type) {
                    case 'mc':
                        answerHtml = (parsedData.options || []).map((option, optIndex) => {
                            const isChecked = parsedData.answer !== undefined && parseInt(parsedData.answer) === optIndex;
                            return `<label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="answer-${index}" value="${optIndex}" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}><span class="ml-3 text-sm text-gray-700">${option}</span></label>`;
                        }).join('');
                        break;
                    case 'tf':
                        const isTrueChecked = parsedData.answer === 'true';
                        const isFalseChecked = parsedData.answer === 'false';
                        answerHtml = `<label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="answer-${index}" value="true" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isTrueChecked ? 'checked' : ''}><span class="ml-3 text-gray-700">Đúng (True)</span></label><label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="answer-${index}" value="false" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isFalseChecked ? 'checked' : ''}><span class="ml-3 text-gray-700">Sai (False)</span></label>`;
                        break;
                    case 'mtf':
                        answerHtml = (parsedData.options || []).map((option, optIndex) => {
                            const isChecked = parsedData.answer && parsedData.answer[optIndex] === true;
                            const isUnchecked = parsedData.answer && parsedData.answer[optIndex] === false;
                            return `<div class="p-2 rounded-md hover:bg-gray-100">
                                        <p class="text-sm text-gray-700 mb-1">${option}</p>
                                        <div class="flex space-x-4">
                                            <label class="flex items-center cursor-pointer"><input type="radio" name="answer-${index}-${optIndex}" value="true" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}><span class="ml-2 text-sm">Đúng</span></label>
                                            <label class="flex items-center cursor-pointer"><input type="radio" name="answer-${index}-${optIndex}" value="false" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isUnchecked ? 'checked' : ''}><span class="ml-2 text-sm">Sai</span></label>
                                        </div>
                                    </div>`;
                        }).join('');
                        break;
                    case 'fib':
                        const prefilledAnswer = parsedData.answer || '';
                        answerHtml = `<input type="text" id="fibAnswer-${index}" placeholder="Nhập đáp án đúng..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="${prefilledAnswer}">`;
                        break;
                }
                const difficultyOptions = `
                    <option value="easy" ${parsedData.difficulty === 'easy' ? 'selected' : ''}>Dễ</option>
                    <option value="medium" ${parsedData.difficulty === 'medium' ? 'selected' : ''}>Trung bình</option>
                    <option value="hard" ${parsedData.difficulty === 'hard' ? 'selected' : ''}>Khó</option>
                `;
                const cognitiveLevelOptions = `
                    <option value="recognition" ${parsedData.cognitiveLevel === 'recognition' ? 'selected' : ''}>Nhận biết</option>
                    <option value="comprehension" ${parsedData.cognitiveLevel === 'comprehension' ? 'selected' : ''}>Thông hiểu</option>
                    <option value="application" ${parsedData.cognitiveLevel === 'application' ? 'selected' : ''}>Vận dụng</option>
                    <option value="high-order-application" ${parsedData.cognitiveLevel === 'high-order-application' ? 'selected' : ''}>Vận dụng cao</option>
                `;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-medium text-gray-800 flex-1">${parsedData.question}</p>
                        <div class="text-right ml-4">
                            <input type="file" id="imageInput-${index}" class="hidden" accept="image/*" onchange="qcHandleImageUpload(event, ${index})">
                            <button type="button" onclick="document.getElementById('imageInput-${index}').click()" class="text-xs bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-full hover:bg-gray-300">Thêm ảnh</button>
                        </div>
                    </div>
                    <div id="imagePreviewContainer-${index}" class="mt-2 flex items-center"><div class="spinner hidden"></div></div>
                    <div class="mt-3 grid grid-cols-2 gap-4">
                         <div>
                            <label for="cognitiveLevel-${index}" class="block text-xs font-medium text-gray-600 mb-1">Mức độ nhận thức</label>
                            <select id="cognitiveLevel-${index}" class="block w-full pl-3 pr-10 py-1.5 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                ${cognitiveLevelOptions}
                            </select>
                        </div>
                        <div>
                            <label for="difficulty-${index}" class="block text-xs font-medium text-gray-600 mb-1">Độ khó</label>
                            <select id="difficulty-${index}" class="block w-full pl-3 pr-10 py-1.5 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                ${difficultyOptions}
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="requiresCalculation-${index}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${parsedData.requiresCalculation ? 'checked' : ''}>
                            <span class="ml-2 text-sm text-gray-700">Cần tính toán</span>
                        </label>
                    </div>
                    <div class="mt-3 space-y-1">${answerHtml}</div>
                `;
                 card.addEventListener('paste', (event) => {
                    handleImagePaste(event, (imageData) => {
                        qcHandleImageUpload({ target: { files: [] } }, index, imageData);
                    });
                });
                return card;
            }
            
            async function uploadImage(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => {
                        showMessage('Không thể đọc tệp hình ảnh.', true);
                        resolve(null);
                    };
                    reader.readAsDataURL(file);
                });
            }

            window.qcHandleImageUpload = async function(event, index, pastedData = null) {
                let imageUrl;
                const previewContainer = qcContainer.querySelector(`#imagePreviewContainer-${index}`);
                const spinner = previewContainer.querySelector('.spinner');
                spinner.classList.remove('hidden');

                if (pastedData) {
                    imageUrl = pastedData;
                } else {
                    const file = event.target.files[0];
                    if (!file) {
                        spinner.classList.add('hidden');
                        return;
                    }
                    imageUrl = await uploadImage(file);
                }
                
                spinner.classList.add('hidden');

                if (imageUrl) {
                    parsedQuestions[index].imageUrl = imageUrl; 
                    previewContainer.innerHTML = `<img src="${imageUrl}" class="image-preview">`;
                    showMessage('Đã thêm ảnh thành công!', false);
                } else {
                    showMessage(`Không thể xử lý ảnh.`, true);
                }
            }

            addAllToListBtn.addEventListener('click', () => {
                let addedCount = 0;
                const selectedSubject = subjectSelect.value; 

                qcContainer.querySelectorAll('.analysis-card').forEach(card => {
                    const index = parseInt(card.dataset.index);
                    const parsedData = parsedQuestions[index];
                    
                    if (parsedData.type === 'mtf') {
                        const groupQuestion = {
                            id: getNextIdForSubject(selectedSubject, questions.length + 1) + "_group",
                            type: 'group',
                            subject: selectedSubject,
                            groupPrompt: parsedData.question,
                            subQuestions: [],
                            difficulty: card.querySelector(`#difficulty-${index}`).value,
                            cognitiveLevel: card.querySelector(`#cognitiveLevel-${index}`).value,
                            requiresCalculation: card.querySelector(`#requiresCalculation-${index}`).checked
                        };

                        (parsedData.options || []).forEach((option, optIndex) => {
                            const selected = card.querySelector(`input[name="answer-${index}-${optIndex}"]:checked`);
                            const answer = selected ? selected.value === 'true' : null;
                            groupQuestion.subQuestions.push({
                                id: `${groupQuestion.id.replace('_group','')}-${optIndex + 1}`,
                                question: option,
                                answer: answer
                            });
                        });
                        questions.push(groupQuestion);
                        addedCount++;

                    } else {
                        const questionData = { 
                            id: getNextIdForSubject(selectedSubject, questions.length + 1),
                            type: parsedData.type, 
                            question: parsedData.question, 
                            subject: selectedSubject,
                            difficulty: card.querySelector(`#difficulty-${index}`).value,
                            cognitiveLevel: card.querySelector(`#cognitiveLevel-${index}`).value,
                            requiresCalculation: card.querySelector(`#requiresCalculation-${index}`).checked
                        };
                        
                        if(parsedData.options) questionData.options = parsedData.options;

                        const imgElement = card.querySelector(`#imagePreviewContainer-${index} img`);
                        if (imgElement && imgElement.src) questionData.imageUrl = imgElement.src;

                        switch(parsedData.type) {
                            case 'mc':
                                const selectedOption = card.querySelector(`input[name="answer-${index}"]:checked`);
                                questionData.answer = selectedOption ? parseInt(selectedOption.value) : (parsedData.answer !== undefined ? parseInt(parsedData.answer) : undefined);
                                break;
                            case 'tf':
                                const selectedTFOption = card.querySelector(`input[name="answer-${index}"]:checked`);
                                questionData.answer = selectedTFOption ? selectedTFOption.value === 'true' : (parsedData.answer !== undefined ? parsedData.answer === 'true' : undefined);
                                break;
                            case 'fib':
                                const fibAnswer = card.querySelector(`#fibAnswer-${index}`).value.trim();
                                questionData.answer = fibAnswer || parsedData.answer;
                                break;
                        }
                        questions.push(questionData);
                        addedCount++;
                    }
                });
                
                rawQuestionText.value = '';
                analysisResultContainer.classList.add('hidden');
                analysisResultSection.innerHTML = '';
                parsedQuestions = [];

                renderQuestionsList();
                updateJsonOutput();

                if(addedCount > 0) showMessage(`Đã thêm thành công ${addedCount} câu hỏi vào danh sách!`, false);
            });

            function renderQuestionsList() {
                const emptyMsg = qcContainer.querySelector('#emptyListMessage');
                const difficultyMap = { easy: 'Dễ', medium: 'Trung bình', hard: 'Khó' };
                const cognitiveLevelMap = { 'recognition': 'Nhận biết', 'comprehension': 'Thông hiểu', 'application': 'Vận dụng', 'high-order-application': 'Vận dụng cao' };

                if (questions.length === 0) {
                    questionsList.innerHTML = '<p id="emptyListMessage" class="text-gray-500 text-center py-4">Chưa có câu hỏi nào.</p>';
                    return;
                }
                
                if(emptyMsg) emptyMsg.remove();
                questionsList.innerHTML = '';
                
                questions.forEach((q) => {
                    const container = document.createElement('div');
                    container.className = 'question-card-container';

                    if (q.type === 'group') {
                        const groupLeadDiv = document.createElement('div');
                        groupLeadDiv.className = 'group-lead';
                        groupLeadDiv.innerHTML = q.groupPrompt;
                        container.appendChild(groupLeadDiv);
                        
                        q.subQuestions.forEach(sq => {
                            const subCardContainer = document.createElement('div');
                            subCardContainer.className = 'flex items-center gap-2 ml-4';
                            const subCard = document.createElement('div');
                            const isUnanswered = sq.answer === undefined || sq.answer === null || sq.answer === '';
                            subCard.className = `question-card bg-gray-50 p-4 rounded-lg border shadow-sm flex-grow ${isUnanswered ? 'border-red-400 border-l-4' : 'border-gray-200'}`;
                            subCard.innerHTML = `<div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-bold text-indigo-700">${sq.id}</p>
                                                        <p class="mt-1 text-gray-800">${sq.question}</p>
                                                        ${isUnanswered ? '<p class="text-xs text-red-600 font-semibold mt-2">Chưa có đáp án</p>' : ''}
                                                    </div>
                                                    <button onclick="qcOpenEditModal('${q.id}')" class="text-xs bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-full hover:bg-blue-200">Sửa nhóm</button>
                                                </div>`;
                            subCardContainer.appendChild(subCard);
                            container.appendChild(subCardContainer);
                        });
                    } else {
                        container.classList.add('flex', 'items-center', 'gap-2');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = q.id;
                        checkbox.className = 'question-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                        checkbox.addEventListener('change', handleSelectionChange);
                        container.appendChild(checkbox);

                        const card = document.createElement('div');
                        const isUnanswered = q.answer === undefined || q.answer === null || q.answer === '';
                        card.className = `question-card bg-gray-50 p-4 rounded-lg border shadow-sm flex-grow ${isUnanswered ? 'border-red-400 border-l-4' : 'border-gray-200'}`;
                        
                        const difficultyText = difficultyMap[q.difficulty] || 'N/A';
                        const cognitiveText = cognitiveLevelMap[q.cognitiveLevel] || 'N/A';
                        const calculationIcon = q.requiresCalculation ? `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-gray-500" viewBox="0 0 16 16" title="Yêu cầu tính toán">
                                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm2 .5v2a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5h-7a.5.5 0 0 0-.5.5zm0 4v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm0 3v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm0 3v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm3-6v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm0 3v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm0 3v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm3-6v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm0 3v4a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5z"/>
                            </svg>` : '';

                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center flex-wrap gap-2 mb-1">
                                        <p class="font-bold text-indigo-700">${q.id} - (${q.type.toUpperCase()})</p>
                                        <span class="badge cognitive-${q.cognitiveLevel.replace('-','')}">${cognitiveText}</span>
                                        <span class="badge difficulty-${q.difficulty}">${difficultyText}</span>
                                        ${calculationIcon}
                                    </div>
                                    <p class="mt-1 text-gray-800">${q.question}</p>
                                    ${q.imageUrl ? `<img src="${q.imageUrl}" class="image-preview mt-2">` : ''}
                                    ${isUnanswered ? '<p class="text-xs text-red-600 font-semibold mt-2">Chưa có đáp án</p>' : ''}
                                </div>
                                <div class="flex flex-col items-end space-y-2">
                                    <button onclick="qcOpenEditModal('${q.id}')" class="text-xs bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-full hover:bg-blue-200">Chỉnh sửa</button>
                                    <button onclick="qcRemoveQuestion('${q.id}')" class="text-xs bg-gray-100 text-gray-600 font-semibold py-1 px-3 rounded-full hover:bg-gray-200">&times; Xóa</button>
                                </div>
                            </div>`;
                        container.appendChild(card);
                    }
                    questionsList.appendChild(container);
                });
            }

            function updateJsonOutput() {
                if (questions.length === 0) {
                    jsonOutput.textContent = '// JSON sẽ tự động cập nhật ở đây...';
                    return;
                }
                jsonOutput.textContent = JSON.stringify(questions, null, 2);
            }

            function renderEditAnswerSection(question) {
                editAnswerSection.innerHTML = '';
                // editQuestionTypeSelect.disabled = !!question.groupId; // Disable type change for grouped questions

                switch(question.type) {
                    case 'mc':
                        const options = question.options && question.options.length > 0 ? question.options : ['', '', '', ''];
                        editAnswerSection.innerHTML = options.map((option, index) => `<div class="flex items-center p-2 rounded-md hover:bg-gray-100"><input type="radio" name="editAnswer" value="${index}" class="h-4 w-4 text-indigo-600" ${question.answer === index ? 'checked' : ''}><input type="text" class="ml-3 text-sm text-gray-700 border-b w-full focus:outline-none focus:border-indigo-500" value="${option}"><button type="button" onclick="qcRemoveOption(this)" class="ml-2 text-red-500 font-bold">&times;</button></div>`).join('') + '<button type="button" onclick="qcAddOption()" class="mt-2 text-sm text-indigo-600 hover:underline">Thêm lựa chọn</button>';
                        break;
                    case 'tf':
                        editAnswerSection.innerHTML = `<label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="editAnswer" value="true" class="h-4 w-4 text-indigo-600" ${question.answer === true ? 'checked' : ''}><span class="ml-3 text-gray-700">Đúng (True)</span></label><label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="editAnswer" value="false" class="h-4 w-4 text-indigo-600" ${question.answer === false ? 'checked' : ''}><span class="ml-3 text-gray-700">Sai (False)</span></label>`;
                        break;
                    case 'fib':
                        const answerText = (question.answer !== undefined && question.answer !== null) ? question.answer : '';
                        editAnswerSection.innerHTML = `<input type="text" id="editFibAnswer" placeholder="Nhập đáp án đúng..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" value="${answerText}">`;
                        break;
                }
            }

            window.qcAddOption = function() {
                const container = qcContainer.querySelector('#editAnswerSection');
                const newOptionDiv = document.createElement('div');
                newOptionDiv.className = 'flex items-center p-2 rounded-md hover:bg-gray-100';
                newOptionDiv.innerHTML = `<input type="radio" name="editAnswer" value="${container.querySelectorAll('input[type=radio]').length}" class="h-4 w-4 text-indigo-600"><input type="text" class="ml-3 text-sm text-gray-700 border-b w-full focus:outline-none focus:border-indigo-500" value=""><button type="button" onclick="qcRemoveOption(this)" class="ml-2 text-red-500 font-bold">&times;</button>`;
                container.insertBefore(newOptionDiv, container.lastChild);
            }

            window.qcRemoveOption = function(button) {
                button.parentElement.remove();
            }

            window.qcOpenEditModal = function(questionId) {
                const question = questions.find(q => q.id === questionId);
                if (!question) return;

                editQuestionIdInput.value = questionId;
                
                const match = question.id.match(/^([A-Z]+)(\d+)/);
                if (match) {
                    editQuestionIdPrefix.textContent = match[1];
                    editQuestionIdNumber.value = parseInt(match[2], 10);
                }

                editQuestionTypeSelect.value = question.type;
                editCognitiveLevelSelect.value = question.cognitiveLevel || 'recognition';
                editDifficultySelect.value = question.difficulty || 'medium';
                editRequiresCalculationCheckbox.checked = question.requiresCalculation || false;
                
                if (question.type === 'group') {
                    editGroupFields.classList.remove('hidden');
                    editNonGroupFields.classList.add('hidden');
                    editGroupPromptTextarea.value = question.groupPrompt || '';
                    renderEditSubQuestions(question.subQuestions || []);
                } else {
                    editGroupFields.classList.add('hidden');
                    editNonGroupFields.classList.remove('hidden');
                    editQuestionText.value = question.question;
                    renderEditAnswerSection(question);
                }
                
                editSubjectSelect.innerHTML = '';
                Array.from(subjectSelect.options).forEach(opt => {
                    const newOpt = document.createElement('option');
                    newOpt.value = opt.value;
                    newOpt.textContent = opt.textContent;
                    if (opt.value === question.subject) newOpt.selected = true;
                    editSubjectSelect.appendChild(newOpt);
                });

                if (question.imageUrl) {
                    editImagePreview.src = question.imageUrl;
                    editImagePreview.classList.remove('hidden');
                    editNoImageText.classList.add('hidden');
                    removeEditImageBtn.classList.remove('hidden');
                } else {
                    editImagePreview.src = '';
                    editImagePreview.classList.add('hidden');
                    editNoImageText.classList.remove('hidden');
                    removeEditImageBtn.classList.add('hidden');
                }

                editModal.classList.remove('hidden');
            }

            editQuestionTypeSelect.addEventListener('change', (event) => {
                const newType = event.target.value;
                if (newType === 'group') {
                    editGroupFields.classList.remove('hidden');
                    editNonGroupFields.classList.add('hidden');
                    renderEditSubQuestions([]);
                } else {
                    editGroupFields.classList.add('hidden');
                    editNonGroupFields.classList.remove('hidden');
                    const tempQuestion = { type: newType };
                    renderEditAnswerSection(tempQuestion);
                }
            });

            editImageInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;

                editImageSpinner.classList.remove('hidden');
                editImagePreview.classList.add('hidden');
                editNoImageText.classList.add('hidden');

                const imageUrl = await uploadImage(file);
                editImageSpinner.classList.add('hidden');

                if (imageUrl) {
                    editImagePreview.src = imageUrl;
                    editImagePreview.classList.remove('hidden');
                    removeEditImageBtn.classList.remove('hidden');
                } else {
                     editNoImageText.classList.remove('hidden');
                     showMessage('Không thể xử lý ảnh.', true);
                }
            }
            
            async function handlePasteButtonClick() {
                try {
                    const clipboardItems = await navigator.clipboard.read();
                    let imageBlob = null;
                    for (const item of clipboardItems) {
                        const imageType = item.types.find(type => type.startsWith('image/'));
                        if (imageType) {
                            imageBlob = await item.getType(imageType);
                            break;
                        }
                    }

                    if (imageBlob) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imageData = e.target.result;
                            editImagePreview.src = imageData;
                            editImagePreview.classList.remove('hidden');
                            editNoImageText.classList.add('hidden');
                            removeEditImageBtn.classList.remove('hidden');
                        };
                        reader.readAsDataURL(imageBlob);
                    } else {
                        showMessage('Không tìm thấy hình ảnh trong clipboard.', true);
                    }
                } catch (err) {
                    console.error('Lỗi khi dán ảnh:', err);
                    showMessage('Không thể dán ảnh. Vui lòng cấp quyền truy cập clipboard cho trang web.', true);
                }
            }
            
            pasteEditImageBtn.addEventListener('click', handlePasteButtonClick);

            removeEditImageBtn.onclick = function() {
                editImagePreview.src = '';
                editImageInput.value = '';
                editImagePreview.classList.add('hidden');
                editNoImageText.classList.remove('hidden');
                removeEditImageBtn.classList.add('hidden');
            }

            cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));

            saveEditBtn.addEventListener('click', () => {
                const originalId = editQuestionIdInput.value;
                const questionIndex = questions.findIndex(q => q.id === originalId);
                if (questionIndex === -1) return;

                const question = questions[questionIndex];

                const newNumber = parseInt(editQuestionIdNumber.value, 10);
                const prefix = editQuestionIdPrefix.textContent;
                const newId = `${prefix}${newNumber.toString().padStart(2, '0')}`;

                const isDuplicate = questions.some(q => q.id === newId && q.id !== originalId);
                if (isDuplicate) {
                    showMessage('Lỗi: ID này đã tồn tại. Vui lòng chọn một số khác.', true);
                    return;
                }
                
                question.id = newId;
                question.type = editQuestionTypeSelect.value;
                question.subject = editSubjectSelect.value;
                question.difficulty = editDifficultySelect.value;
                question.cognitiveLevel = editCognitiveLevelSelect.value;
                question.requiresCalculation = editRequiresCalculationCheckbox.checked;
                
                if (question.type === 'group') {
                    question.groupPrompt = cleanAiHtmlResponse(editGroupPromptTextarea.value);
                    const subQuestions = [];
                    editSubQuestionsContainer.querySelectorAll('.sub-question-group').forEach((group, index) => {
                        subQuestions.push({
                            id: `${newId}-${index + 1}`,
                            question: group.querySelector('textarea').value,
                            answer: group.querySelector('input[type="radio"]:checked')?.value === 'true'
                        });
                    });
                    question.subQuestions = subQuestions;
                    delete question.question;
                    delete question.answer;
                    delete question.options;
                } else {
                    question.question = editQuestionText.value;
                    delete question.groupPrompt;
                    delete question.subQuestions;
                    
                    switch(question.type) {
                        case 'mc':
                            const selectedOption = editAnswerSection.querySelector('input[name="editAnswer"]:checked');
                            question.answer = selectedOption ? parseInt(selectedOption.value) : undefined;
                            const optionInputs = editAnswerSection.querySelectorAll('input[type="text"]');
                            question.options = Array.from(optionInputs).map(input => input.value);
                            break;
                        case 'tf':
                            const selectedTFOption = editAnswerSection.querySelector('input[name="editAnswer"]:checked');
                            question.answer = selectedTFOption ? (selectedTFOption.value === 'true') : undefined;
                            break;
                        case 'fib':
                            const fibAnswer = qcContainer.querySelector('#editFibAnswer').value.trim();
                            question.answer = fibAnswer ? fibAnswer : undefined;
                            break;
                    }
                }

                const hasImage = editImagePreview.src && editImagePreview.src.startsWith('data:image');
                if (hasImage) {
                    question.imageUrl = editImagePreview.src;
                } else {
                    delete question.imageUrl;
                }

                renderQuestionsList();
                updateJsonOutput();
                editModal.classList.add('hidden');
                showMessage(`Đã cập nhật câu hỏi ${question.id}`, false);
            });

            window.qcRemoveQuestion = function(questionId) {
                questions = questions.filter(q => q.id !== questionId);
                renderQuestionsList();
                updateJsonOutput();
                showMessage('Đã xóa câu hỏi.', false);
            }
            
            function handleSelectionChange() {
                const selected = questionsList.querySelectorAll('.question-checkbox:checked');
                const allAreTf = Array.from(selected).every(cb => {
                    const q = questions.find(q => q.id === cb.value);
                    return q && q.type === 'tf';
                });
                groupBtn.classList.toggle('hidden', selected.length < 2 || !allAreTf);
            }

            groupBtn.addEventListener('click', () => {
                groupPromptInput.value = '';
                groupModal.classList.remove('hidden');
            });

            cancelGroupBtn.addEventListener('click', () => {
                groupModal.classList.add('hidden');
            });

            confirmGroupBtn.addEventListener('click', () => {
                const selectedCheckboxes = questionsList.querySelectorAll('.question-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                let groupPrompt = groupPromptInput.value.trim();
                groupPrompt = cleanAiHtmlResponse(groupPrompt);


                if (groupPrompt === '') {
                    showMessage('Vui lòng nhập phần dẫn chung.', true);
                    return;
                }

                const firstQuestion = questions.find(q => q.id === selectedIds[0]);
                if (!firstQuestion) return;

                const newGroupQuestion = {
                    id: getNextIdForSubject(firstQuestion.subject, questions.length + 1) + "_group",
                    type: 'group',
                    subject: firstQuestion.subject,
                    groupPrompt: groupPrompt,
                    subQuestions: [],
                    difficulty: firstQuestion.difficulty,
                    cognitiveLevel: firstQuestion.cognitiveLevel,
                    requiresCalculation: firstQuestion.requiresCalculation
                };

                selectedIds.forEach((id, index) => {
                    const q = questions.find(q => q.id === id);
                    if (q) {
                        newGroupQuestion.subQuestions.push({
                            id: `${newGroupQuestion.id.replace('_group','')}-${index + 1}`,
                            question: q.question,
                            answer: q.answer
                        });
                    }
                });
                
                questions = questions.filter(q => !selectedIds.includes(q.id));
                questions.push(newGroupQuestion);

                groupModal.classList.add('hidden');
                renderQuestionsList();
                updateJsonOutput();
                showMessage('Đã nhóm các câu hỏi thành công.', false);
            });


            function ungroupQuestions(questionId) {
                const groupQuestionIndex = questions.findIndex(q => q.id === questionId);
                if (groupQuestionIndex === -1) return;

                const groupQuestion = questions[groupQuestionIndex];
                const newQuestions = groupQuestion.subQuestions.map(sq => ({
                    ...sq,
                    type: 'tf',
                    subject: groupQuestion.subject,
                    difficulty: groupQuestion.difficulty,
                    cognitiveLevel: groupQuestion.cognitiveLevel,
                    requiresCalculation: groupQuestion.requiresCalculation,
                }));

                questions.splice(groupQuestionIndex, 1, ...newQuestions);
                
                editModal.classList.add('hidden');
                renderQuestionsList();
                updateJsonOutput();
                showMessage('Đã bỏ nhóm câu hỏi.', false);
            }

            copyJsonBtn.addEventListener('click', function() {
                const jsonText = jsonOutput.textContent;
                if (questions.length > 0 && !jsonText.startsWith('//')) {
                    const textarea = document.createElement('textarea');
                    textarea.value = jsonText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showMessage('Đã sao chép vào clipboard!', false);
                    } catch (err) {
                        showMessage('Sao chép thất bại!', true);
                    }
                    document.body.removeChild(textarea);
                } else {
                    showMessage('Không có gì để sao chép.', true);
                }
            });
            
            downloadJsonBtn.addEventListener('click', function() {
                const jsonText = jsonOutput.textContent;
                if (questions.length > 0 && !jsonText.startsWith('//')) {
                    const blob = new Blob([jsonText], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'questions.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Bắt đầu tải xuống...', false);
                } else {
                    showMessage('Không có gì để tải xuống.', true);
                }
            });

            importJsonBtn.addEventListener('click', () => {
                importFileInput.click();
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    let importedData;
                    try {
                        importedData = JSON.parse(e.target.result);
                    } catch (initialError) {
                        try {
                            let text = e.target.result.trim();
                            if (text.endsWith(';')) text = text.slice(0, -1);
                            text = text.replace(/([{,]\s*)(\w+)(\s*:)/g, '$1"$2"$3').replace(/'/g, '"');
                            importedData = JSON.parse(text);
                        } catch (fallbackError) {
                            showMessage(`Lỗi khi nhập tệp: Định dạng không hợp lệ.`, true);
                            return;
                        }
                    }

                    if (!Array.isArray(importedData)) {
                        showMessage('Lỗi: Tệp JSON phải chứa một mảng các câu hỏi.', true);
                        return;
                    }
                    
                    const isValid = importedData.every(q => q && typeof q.id === 'string' && typeof q.type === 'string' && (q.type === 'group' ? q.groupPrompt && Array.isArray(q.subQuestions) : typeof q.question === 'string'));
                    if (!isValid) {
                         showMessage('Lỗi: Một hoặc nhiều câu hỏi trong tệp bị thiếu các trường bắt buộc.', true);
                         return;
                    }

                    const ids = new Set();
                    const duplicates = [];
                    importedData.forEach(q => {
                        if (ids.has(q.id)) {
                            duplicates.push(q.id);
                        }
                        ids.add(q.id);
                        if(q.type === 'group' && q.subQuestions) {
                            q.subQuestions.forEach(sq => {
                                if(ids.has(sq.id)) duplicates.push(sq.id);
                                ids.add(sq.id);
                            });
                        }
                    });
                    if (duplicates.length > 0) {
                        showMessage(`Cảnh báo: Tệp chứa các ID trùng lặp: ${duplicates.join(', ')}. Vui lòng sửa lại.`, true);
                        return;
                    }

                    questions = importedData;
                    renderQuestionsList();
                    updateJsonOutput();
                    showMessage(`Đã nhập thành công ${questions.length} câu hỏi.`, false);
                    importFileInput.value = '';
                };
                reader.onerror = () => {
                    showMessage('Không thể đọc tệp.', true);
                };
                reader.readAsText(file);
            });

            addQuestionBtn.addEventListener('click', () => {
                const newQuestion = {
                    id: getNextIdForSubject(subjectSelect.value, questions.length + 1),
                    type: 'mc', // Default to MC for manual creation
                    question: 'Câu hỏi mới',
                    subject: subjectSelect.value,
                    difficulty: 'medium',
                    cognitiveLevel: 'recognition',
                    requiresCalculation: false,
                    answer: undefined,
                    options: ['', '', '', '']
                };
                questions.push(newQuestion);
                renderQuestionsList();
                updateJsonOutput();
                qcOpenEditModal(newQuestion.id); // Open modal immediately
            });

             // Initial render
            renderQuestionsList();
            updateJsonOutput();
        })();
    </script>
</body>
</html>
